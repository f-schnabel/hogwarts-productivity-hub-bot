{% extends "layout.twig" %}

{% block content %}
<div class="user-header" style="--house-color: {{ houseColor }}">
  <h1>{{ displayName }}</h1>
  <p class="user-house" style="color: {{ houseColor }}">{{ house ?? "No House" }}</p>
</div>

<div class="stat-grid">
  <div class="stat">
    <div class="stat-value">{{ monthlyPoints }}</div>
    <div class="stat-label">Monthly Points</div>
  </div>
  <div class="stat">
    <div class="stat-value">{{ monthlyStudy }}</div>
    <div class="stat-label">Monthly Study</div>
  </div>
  <div class="stat">
    <div class="stat-value">{{ messageStreak }}</div>
    <div class="stat-label">Streak</div>
  </div>
  <div class="stat">
    <div class="stat-value">{{ totalPoints }}</div>
    <div class="stat-label">All-Time Points</div>
  </div>
  <div class="stat">
    <div class="stat-value">{{ totalStudy }}</div>
    <div class="stat-label">All-Time Study</div>
  </div>
</div>

<div class="year-rank">
  <h2>Year Progress</h2>
  <div class="year-badge" style="color: {{ yearProgress.badgeColor }}">{{ yearProgress.badge }}</div>
  <div class="progress-container">
    <div class="progress-bar" style="width: {{ yearProgress.percent }}%; --bar-start: {{ yearProgress.barStart }}; --bar-end: {{ yearProgress.barEnd }}; --bar-glow: {{ yearProgress.barGlow }}"></div>
    <div class="progress-text">{{ yearProgress.text }}</div>
  </div>
  <div class="year-info">
    <span>{{ yearProgress.leftLabel }}</span>
    <span class="next-rank" {% if yearProgress.isMax %}style="color: var(--accent-gold-bright)"{% endif %}>{{ yearProgress.rightLabel }}</span>
  </div>
</div>

<div class="sessions">
  <h2>Activity This Month</h2>
  <div class="chart-container">
    <canvas id="studyChart"></canvas>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
Chart.defaults.font.family = "'Outfit', system-ui, sans-serif";
new Chart(document.getElementById('studyChart'), {
  data: {
    labels: {{ chartLabels|json_encode|raw }},
    datasets: [{
      type: 'line',
      label: 'Study Hours',
      data: {{ chartHours|json_encode|raw }},
      borderColor: '{{ houseColor }}',
      backgroundColor: '{{ houseColor }}22',
      fill: true,
      tension: 0.4,
      pointRadius: 0,
      pointHoverRadius: 6,
      pointHoverBackgroundColor: '{{ houseColor }}',
      pointHoverBorderColor: '#fff',
      pointHoverBorderWidth: 2,
      borderWidth: 2,
      yAxisID: 'y'
    }, {
      type: 'bar',
      label: 'To-Do Points',
      data: {{ chartTodoPoints|json_encode|raw }},
      backgroundColor: 'rgba(212, 168, 83, 0.4)',
      borderColor: 'rgba(212, 168, 83, 0.8)',
      borderWidth: 1,
      borderRadius: 4,
      yAxisID: 'y1'
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: true,
    interaction: {
      intersect: false,
      mode: 'index'
    },
    plugins: {
      legend: {
        display: true,
        position: 'top',
        labels: {
          color: 'rgba(240, 230, 211, 0.7)',
          padding: 20,
          usePointStyle: true,
          pointStyle: 'circle'
        }
      },
      tooltip: {
        backgroundColor: 'rgba(20, 20, 35, 0.95)',
        titleColor: '#f0e6d3',
        bodyColor: 'rgba(240, 230, 211, 0.8)',
        borderColor: 'rgba(212, 168, 83, 0.3)',
        borderWidth: 1,
        cornerRadius: 8,
        padding: 12
      }
    },
    scales: {
      x: {
        ticks: {
          color: 'rgba(240, 230, 211, 0.5)',
          maxRotation: 45,
          font: { size: 11 }
        },
        grid: { color: 'rgba(255, 255, 255, 0.05)' }
      },
      y: {
        type: 'linear',
        position: 'left',
        title: {
          display: true,
          text: 'Hours',
          color: 'rgba(240, 230, 211, 0.5)',
          font: { size: 11 }
        },
        ticks: { color: 'rgba(240, 230, 211, 0.5)' },
        grid: { color: 'rgba(255, 255, 255, 0.05)' },
        beginAtZero: true
      },
      y1: {
        type: 'linear',
        position: 'right',
        title: {
          display: true,
          text: 'To-Do Pts',
          color: 'rgba(240, 230, 211, 0.5)',
          font: { size: 11 }
        },
        ticks: { color: 'rgba(240, 230, 211, 0.5)', stepSize: 5 },
        grid: { drawOnChartArea: false },
        beginAtZero: true,
        max: 15
      }
    }
  }
});
</script>
{% endblock %}
