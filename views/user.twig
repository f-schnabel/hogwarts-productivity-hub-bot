{% extends "layout.twig" %}

{% block styles %}
<style>
  .user-header {
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--border-subtle);
    padding: 3rem 2rem;
    border-radius: 24px;
    text-align: center;
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
    animation: fadeSlideDown 0.6s ease-out;
  }

  .user-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, transparent, var(--house-color), transparent);
  }

  .user-header h1 {
    margin-bottom: 0.5rem;
  }

  .user-house {
    font-family: 'Cinzel', serif;
    font-size: 1rem;
    font-weight: 500;
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  .stat-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 1rem;
    margin: 1.5rem 0;
  }

  .stat {
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--border-subtle);
    padding: 1.5rem 1rem;
    border-radius: 16px;
    text-align: center;
    transition: all 0.3s ease;
  }

  .stat:hover {
    border-color: var(--border-glow);
    transform: translateY(-2px);
  }

  .stat-value {
    font-size: 1.75rem;
    font-weight: 600;
    color: var(--accent-gold-bright);
    letter-spacing: -0.02em;
  }

  .stat-label {
    font-size: 0.75rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-top: 0.5rem;
  }

  .year-rank {
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--border-subtle);
    border-radius: 20px;
    padding: 2rem;
    margin: 2rem 0;
    animation: fadeSlideUp 0.6s ease-out 0.3s both;
  }

  .year-badge {
    font-family: 'Cinzel', serif;
    font-size: 2rem;
    font-weight: 700;
    letter-spacing: 0.05em;
  }

  .progress-container {
    background: rgba(0, 0, 0, 0.4);
    border-radius: 14px;
    height: 32px;
    overflow: hidden;
    position: relative;
    margin: 1.25rem 0;
    border: 1px solid rgba(255, 255, 255, 0.05);
  }

  .progress-bar {
    height: 100%;
    border-radius: 14px;
    background: linear-gradient(90deg, var(--bar-start) 0%, var(--bar-end) 100%);
    box-shadow: 0 0 15px var(--bar-glow);
    position: relative;
    transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .progress-bar::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: inherit;
    box-shadow: 0 0 30px var(--bar-glow), 0 0 50px var(--bar-glow);
    opacity: 0;
    animation: barGlowPulse 5s ease-in-out infinite;
  }

  @keyframes barGlowPulse {
    0%, 100% { opacity: 0; }
    50% { opacity: 1; }
  }

  .progress-info {
    display: flex;
    align-items: center;
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-top: 0.75rem;
  }

  .progress-info > span:first-child {
    flex: 1;
    text-align: left;
  }

  .progress-info > span:last-child {
    flex: 1;
    text-align: right;
  }

  .progress-text {
    font-weight: 600;
    font-size: 0.9rem;
    letter-spacing: 0.02em;
    color: rgba(240, 230, 211, 0.8);
    text-align: center;
  }

  .next-rank {
    color: var(--accent-gold);
  }

  .sessions {
    margin-top: 2rem;
    animation: fadeSlideUp 0.6s ease-out 0.4s both;
  }

  .chart-container {
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--border-subtle);
    border-radius: 20px;
    padding: 1.5rem;
  }

  .todo-orbs-legend {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 6px;
    margin-top: 0.75rem;
    padding-right: 0.5rem;
  }

  .orb-sample {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: radial-gradient(circle at 35% 35%, #fff8e7, #d4a853 60%, #a67c30);
    box-shadow: 0 0 8px rgba(212, 168, 83, 0.9), 0 0 16px rgba(212, 168, 83, 0.4);
  }

  .orb-label {
    font-size: 0.7rem;
    color: var(--text-muted);
    letter-spacing: 0.02em;
  }

  .stat:nth-child(1) { animation: fadeSlideUp 0.4s ease-out 0.1s both; }
  .stat:nth-child(2) { animation: fadeSlideUp 0.4s ease-out 0.15s both; }
  .stat:nth-child(3) { animation: fadeSlideUp 0.4s ease-out 0.2s both; }
  .stat:nth-child(4) { animation: fadeSlideUp 0.4s ease-out 0.25s both; }
  .stat:nth-child(5) { animation: fadeSlideUp 0.4s ease-out 0.3s both; }

  @media (max-width: 640px) {
    .user-header { padding: 2rem 1.5rem; }
    .todo-orbs-legend { margin-top: 0.5rem; gap: 4px; }
    .orb-sample { width: 7px; height: 7px; }
    .orb-label { font-size: 0.6rem; }
  }
</style>
{% endblock %}

{% block content %}
<div class="user-header" style="--house-color: {{ houseColor }}">
  <h1>{{ displayName }}</h1>
  <p class="user-house" style="color: {{ houseColor }}">{{ house ?? "No House" }}</p>
</div>

<div class="stat-grid">
  <div class="stat">
    <div class="stat-value">{{ monthlyPoints }}</div>
    <div class="stat-label">Monthly Points</div>
  </div>
  <div class="stat">
    <div class="stat-value">{{ monthlyStudy }}</div>
    <div class="stat-label">Monthly Study</div>
  </div>
  <div class="stat">
    <div class="stat-value">{{ messageStreak }}</div>
    <div class="stat-label">Streak</div>
  </div>
</div>

<div class="year-rank">
  <h2>Year Progress</h2>
  <div class="year-badge" style="color: {{ yearProgress.badgeColor }}">{{ yearProgress.badge }}</div>
  <div class="progress-container">
    <div class="progress-bar" style="width: {{ yearProgress.percent }}%; --bar-start: {{ yearProgress.barStart }}; --bar-end: {{ yearProgress.barEnd }}; --bar-glow: {{ yearProgress.barGlow }}"></div>
  </div>
  <div class="progress-info">
    <span>{{ yearProgress.leftLabel }}</span>
    <span class="progress-text">{{ yearProgress.text }}</span>
    <span class="next-rank" {% if yearProgress.isMax %}style="color: var(--accent-gold-bright)"{% endif %}>{{ yearProgress.rightLabel }}</span>
  </div>
</div>

<div class="sessions">
  <h2>Activity This Month</h2>
  <div class="chart-container">
    <canvas id="studyChart"></canvas>
  </div>
  <div class="todo-orbs-legend">
    <span class="orb-sample"></span>
    <span class="orb-label">= 5 to-do points</span>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const todoPoints = {{ chartTodoPoints|json_encode|raw }};
const yearLines = {{ yearLines|json_encode|raw }};
const hasThirdRow = todoPoints.some(p => p >= 15);
const isMobileInit = window.innerWidth < 500;

// Plugin to draw year threshold horizontal lines
const yearLinesPlugin = {
  id: 'yearLines',
  afterDraw(chart) {
    const { ctx, chartArea, scales: { y } } = chart;
    if (!chartArea) return;

    const isMobile = chartArea.width < 400;

    yearLines.forEach((line, index) => {
      const yPos = y.getPixelForValue(line.hours);
      if (yPos < chartArea.top || yPos > chartArea.bottom) return;

      ctx.save();

      // Draw dashed line
      ctx.strokeStyle = line.color;
      ctx.lineWidth = 1.5;
      ctx.setLineDash([6, 4]);
      ctx.globalAlpha = 0.6;

      ctx.beginPath();
      ctx.moveTo(chartArea.left, yPos);
      ctx.lineTo(chartArea.right, yPos);
      ctx.stroke();

      // Draw label - on mobile, position inline on left side of line
      ctx.setLineDash([]);
      ctx.globalAlpha = 1;
      ctx.fillStyle = line.color;

      if (isMobile) {
        // Mobile: small badge on left, inline with line
        ctx.font = "600 8px 'Cinzel', serif";
        ctx.textAlign = 'left';
        ctx.textBaseline = 'middle';

        const text = line.label.replace('Year ', 'Y');
        const textWidth = ctx.measureText(text).width;
        const padding = 4;
        const badgeWidth = textWidth + padding * 2;
        const badgeHeight = 14;
        const badgeX = chartArea.left + 4;
        const badgeY = yPos;

        // Badge background
        ctx.fillStyle = 'rgba(10, 10, 18, 0.85)';
        ctx.beginPath();
        ctx.roundRect(badgeX, badgeY - badgeHeight/2, badgeWidth, badgeHeight, 3);
        ctx.fill();

        // Badge border
        ctx.strokeStyle = line.color;
        ctx.lineWidth = 1;
        ctx.setLineDash([]);
        ctx.globalAlpha = 0.7;
        ctx.stroke();

        // Badge text
        ctx.globalAlpha = 1;
        ctx.fillStyle = line.color;
        ctx.fillText(text, badgeX + padding, badgeY + 1);
      } else {
        // Desktop: labels on right
        ctx.font = "600 10px 'Cinzel', serif";
        ctx.textAlign = 'right';
        ctx.textBaseline = 'bottom';
        ctx.fillText(line.label, chartArea.right - 4, yPos - 3);
      }

      ctx.restore();
    });
  }
};

Chart.register(yearLinesPlugin);

const orbPlugin = {
  id: 'todoOrbs',
  afterDatasetsDraw(chart) {
    const { ctx, scales: { x }, chartArea } = chart;
    const bottomY = chartArea.bottom;
    const isMobile = chartArea.width < 400;

    // Responsive sizing
    const orbRadius = isMobile ? 3.5 : 5;
    const orbGap = isMobile ? 2 : 3;
    const topRowY = bottomY + (isMobile ? 28 : 36);
    const bottomRowY = topRowY + orbRadius * 2 + (isMobile ? 3 : 4);

    const time = Date.now() / 1000;

    function drawOrb(drawX, drawY, isActive, phase, size) {
      const r = size || orbRadius;
      const pulse = isActive ? 1 + Math.sin(phase * 2) * 0.12 : 1;
      const finalR = r * pulse;

      ctx.save();

      if (isActive) {
        // Reduced glow on mobile
        if (!isMobile) {
          const glow = ctx.createRadialGradient(drawX, drawY, 0, drawX, drawY, finalR * 3);
          glow.addColorStop(0, 'rgba(212, 168, 83, 0.4)');
          glow.addColorStop(0.5, 'rgba(212, 168, 83, 0.15)');
          glow.addColorStop(1, 'rgba(212, 168, 83, 0)');
          ctx.fillStyle = glow;
          ctx.beginPath();
          ctx.arc(drawX, drawY, finalR * 3, 0, Math.PI * 2);
          ctx.fill();
        }

        const gradient = ctx.createRadialGradient(
          drawX - finalR * 0.3, drawY - finalR * 0.3, 0,
          drawX, drawY, finalR
        );
        gradient.addColorStop(0, '#fff8e7');
        gradient.addColorStop(0.4, '#f0c674');
        gradient.addColorStop(0.8, '#d4a853');
        gradient.addColorStop(1, '#a67c30');
        ctx.fillStyle = gradient;
      } else {
        const dimGradient = ctx.createRadialGradient(
          drawX - finalR * 0.2, drawY - finalR * 0.2, 0,
          drawX, drawY, finalR
        );
        dimGradient.addColorStop(0, 'rgba(80, 80, 100, 0.5)');
        dimGradient.addColorStop(1, 'rgba(40, 40, 60, 0.4)');
        ctx.fillStyle = dimGradient;
      }

      ctx.beginPath();
      ctx.arc(drawX, drawY, finalR, 0, Math.PI * 2);
      ctx.fill();

      if (isActive && !isMobile) {
        ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
        ctx.beginPath();
        ctx.arc(drawX - finalR * 0.35, drawY - finalR * 0.35, finalR * 0.25, 0, Math.PI * 2);
        ctx.fill();
      }

      ctx.restore();
    }

    // On mobile, only show orbs for days with points (skip inactive)
    todoPoints.forEach((points, i) => {
      const centerX = x.getPixelForValue(i);
      const dotCount = Math.floor(points / 5);

      if (isMobile) {
        // Mobile: single stacked column, only show active orbs
        if (dotCount > 0) {
          for (let d = 0; d < Math.min(dotCount, 3); d++) {
            const offsetY = d * (orbRadius * 2 + 2);
            const phase = time + i * 0.15 + d * 0.3;
            drawOrb(centerX, topRowY + offsetY, true, phase);
          }
        }
      } else {
        // Desktop: original layout
        // Top row: 2 dots max (horizontal)
        for (let d = 0; d < 2; d++) {
          const isActive = d < dotCount;
          const offsetX = (d - 0.5) * (orbRadius * 2 + orbGap);
          const phase = time + i * 0.15 + d * 0.3;
          drawOrb(centerX + offsetX, topRowY, isActive, phase);
        }

        // Bottom row: 1 dot centered (only show if 15+ pts)
        if (dotCount >= 3) {
          const phase = time + i * 0.15 + 2 * 0.3;
          drawOrb(centerX, bottomRowY, true, phase);
        }
      }
    });
  }
};

Chart.register(orbPlugin);

Chart.defaults.font.family = "'Outfit', system-ui, sans-serif";

const chart = new Chart(document.getElementById('studyChart'), {
  type: 'line',
  data: {
    labels: {{ chartLabels|json_encode|raw }},
    datasets: [{
      label: 'Study Hours',
      data: {{ chartHours|json_encode|raw }},
      borderColor: '{{ houseColor }}',
      backgroundColor: '{{ houseColor }}22',
      fill: true,
      tension: 0.4,
      pointRadius: 0,
      pointHoverRadius: 6,
      pointHoverBackgroundColor: '{{ houseColor }}',
      pointHoverBorderColor: '#fff',
      pointHoverBorderWidth: 2,
      borderWidth: 2.5
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: true,
    layout: {
      padding: { bottom: isMobileInit ? (hasThirdRow ? 42 : 28) : (hasThirdRow ? 58 : 38) }
    },
    interaction: {
      intersect: false,
      mode: 'index'
    },
    plugins: {
      legend: { display: false },
      tooltip: {
        backgroundColor: 'rgba(15, 15, 25, 0.95)',
        titleColor: '#f0e6d3',
        titleFont: { family: "'Cinzel', serif", size: 13, weight: 600 },
        bodyColor: 'rgba(240, 230, 211, 0.85)',
        bodyFont: { size: 12 },
        borderColor: 'rgba(212, 168, 83, 0.4)',
        borderWidth: 1,
        cornerRadius: 10,
        padding: 14,
        displayColors: false,
        callbacks: {
          afterBody: function(context) {
            const idx = context[0].dataIndex;
            const pts = todoPoints[idx];
            if (pts > 0) {
              const dots = Math.floor(pts / 5);
              return '\n✦ ' + pts + ' to-do pts (' + '●'.repeat(dots) + ')';
            }
            return '';
          }
        }
      }
    },
    scales: {
      x: {
        ticks: {
          color: 'rgba(240, 230, 211, 0.5)',
          maxRotation: 0,
          font: { size: 10 }
        },
        grid: { color: 'rgba(255, 255, 255, 0.04)' }
      },
      y: {
        title: {
          display: true,
          text: 'Study Hours',
          color: 'rgba(240, 230, 211, 0.45)',
          font: { size: 11, family: "'Outfit', sans-serif" }
        },
        ticks: {
          color: 'rgba(240, 230, 211, 0.45)',
          font: { size: 10 }
        },
        grid: { color: 'rgba(255, 255, 255, 0.04)' },
        beginAtZero: true,
        max: {{ chartYMax ?? 'undefined' }}
      }
    },
    animation: {
      duration: 1200,
      easing: 'easeOutQuart'
    }
  }
});

function animateOrbs() {
  chart.draw();
  requestAnimationFrame(animateOrbs);
}
animateOrbs();
</script>
{% endblock %}
